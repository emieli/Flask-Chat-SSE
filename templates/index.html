<!DOCTYPE html>
<html>

<head>
  <title>Flask Chat</title>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

</head>

<body class="bg-dark">
  <div class="container">
    <h1 class="text-white text-center">Flask Chat</h1>
    <div class="row">
      <div class="col-sm-10" style="padding-right: 0;">
        <form id="SendMessage" onsubmit="return FormSubmit()">
          <div class="input-group">
            <textarea class="form-control mb-3" id="chatbox" rows="5">Connecting to server...</textarea>
          </div>
          <input class="form-control" type="text" name="message" id="messagebox" placeholder="Enter message"
            autocomplete="off" , autofocus="on">
        </form>
      </div>
      <div class="col-sm-2">
        <textarea class="form-control mb-3" id="userbox" rows="5" readonly></textarea>
      </div>
    </div>
  </div>

  <script>

    // We submit the form with AJAX to stop the page from reloading when submitted
    function FormSubmit() {
      var data = new FormData(document.getElementById("SendMessage"));
      data.append('uuid', uuid);
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/");
      xhr.send(data);
      messagebox.value = ""; // Clear message box
      return false; // Stops the HTML from submitting itself
    }

    // We use SSE (Server-side Events) to listen for messages from the server
    const uuid = self.crypto.randomUUID(); // I want to use uuid to send some data to a specific client.
    let username = localStorage.getItem("username");
    const sse = new EventSource(`{{ url_for('listen') }}/${uuid}&${username}`);
    const chatbox = document.querySelector("#chatbox");
    const userbox = document.querySelector("#userbox");
    const messagebox = document.querySelector("#messagebox");

    // Connection is successfully established
    sse.addEventListener('connected', (event) => {
      // console.log(event);
      chatbox.textContent = event.data;
      chatbox.scrollTop = chatbox.scrollHeight;
    });

    // Username received from server
    sse.addEventListener('newUsername', (event) => {
      // console.log(event);
      username = event.data;
      localStorage.setItem("username", username);
    });

    // Retrieve user list
    sse.addEventListener('userlist', (event) => {
      console.log(event);
      userbox.textContent = event.data;
    });

    // An alert is shown if SSE session fails to establish
    sse.addEventListener('error', (event) => {
      // console.log(event);
      chatbox.textContent = "Failed to connect to server.";
      userbox.textContent = ""; // Clear users
    });

    // A generic message receiver. Other event types can be generated
    sse.addEventListener('message', (event) => {
      // console.log(event);
      chatbox.textContent += "\n" + event.data;
      chatbox.scrollTop = chatbox.scrollHeight;
    });

  </script>

</body>

</html>